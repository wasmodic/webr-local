<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>webR Bioinformatics Demo with Local Package</title>

  <!-- Load webR (current stable release) -->
  <script src="https://webr.r-wasm.org/latest/webr.mjs" type="module"></script>

  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    textarea {
      width: 100%;
      box-sizing: border-box;
      font-family: monospace;
    }
    button {
      margin-top: 0.75rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      cursor: pointer;
    }
    pre {
      background: #f5f5f5;
      padding: 0.75rem;
      white-space: pre-wrap;
      overflow-x: auto;
    }
    .status {
      font-size: 0.9rem;
      color: #555;
    }
  </style>
</head>

<body>
  <h1>webR Bioinformatics Demo</h1>
  <p>
    This page runs R entirely in your browser using webR. It computes GC content
    and the reverse complement of a DNA sequence. These functiosn come from a local R package (wasmodicR)
    that is hosted on this repo's GitHub pages, and could be called from any WebR instance.

    The output should be the same as <a href="https://github.com/wasmodic/webr/">https://github.com/wasmodic/webr/</a>
    </p>

    <pre>
      library(webr)
      webr::mount(mountpoint = "/wasmodicR", source = "https://wasmodic.github.io/webr-local/library.data");
      .libPaths(c(.libPaths(), "/wasmodicR"));
      library(wasmodicR)
      wasmodicR::wasmodic()
      </pre>

  <label for="seq"><strong>DNA sequence (supports FASTA):</strong></label>
  <textarea id="seq" rows="6">
>Example sequence
ATGGCCATTGTAATGGGCCGCTGAAAGGGTGCCCGATAG
  </textarea>

  <div class="status" id="status">Loading webR...</div>
  <button id="run" disabled>Analyze sequence</button>

  <h2>Results</h2>
  <pre id="output">(waiting)</pre>

  <!-- Main webR logic -->
  <script type="module">
    import { WebR } from "https://webr.r-wasm.org/latest/webr.mjs";

    const statusEl = document.getElementById("status");
    const outputEl = document.getElementById("output");
    const runBtn = document.getElementById("run");

    const webR = new WebR();

    async function init() {
      statusEl.textContent = "Starting webR...";
      await webR.init();



      statusEl.textContent = "Installing stringr package...";
      await webR.installPackages(['stringr']);

        await webR.evalR(`
        webr::mount(mountpoint = "/wasmodicR", source = "https://wasmodic.github.io/webr-local/library.data");
        .libPaths(c(.libPaths(), "/wasmodicR"));
        library(wasmodicR);
        message("WasmodicR is loaded")
    `);



      statusEl.textContent = "webR ready.";
      runBtn.disabled = false;

     }

    init();

    runBtn.addEventListener("click", async () => {
      runBtn.disabled = true;
      statusEl.textContent = "Running...";

      const seq = document.getElementById("seq").value;

      // Move input text into R
      await webR.objs.globalEnv.bind("rawseq", seq);

      // Perform analysis in R
      const result = await webR.evalR(`
library(wasmodicR)
library(stringr)

seq_clean <- wasmodicR::clean_seq(rawseq)
gc <- wasmodicR::gc_content(seq_clean)
revseq <- wasmodicR::rev_comp(seq_clean)

paste(
  sprintf("Cleaned length: %d", gc$len),
  sprintf("GC bases: %d", gc$gc),
  sprintf("GC content: %.2f%%", gc$pct),
  "",
  "Reverse complement:",
  revseq,
  sep = "\\n"
)

wasmodicR::wasmodic()

`, { captureStreams: true });

      const text = await result.toJs();
      outputEl.textContent = text.values[0];
      statusEl.textContent = "Done.";
      runBtn.disabled = false;
    });
  </script>
</body>
</html>
